---
title: "Calculating a threshold value for extreme heat"
format: html
author: "Charlie Curtin"
---

```{r, message = FALSE}
# load libraries
library(devtools)
library(caladaptr)
library(tidyverse)
library(sf)
library(here)
library(progress) # for loop progress bar

# install caladaptr to construct an API request for climate data from Cal-Adapt
#devtools::install_github("ucanr-igis/caladaptr")
```

## Request daily maximum temperature for California school districts

We are going to begin by requesting daily maximum temperature data for the area covering California school districts. The data come in the form of 6km x 6km gridded squares. The historical period covers observed data, from the years 1950-2013. We choose 1961-1990 based on the methods of the Cal-Adapt tool, where 1961-1990 are considered the baseline. Here's the tool: https://cal-adapt.org/tools/extreme-heat/

```{r}
# read in school districts
districts <- st_read(here("data", "school_districts"), quiet = TRUE)

# generate districts centroids
districts_points <- st_centroid(districts)
```

# construct API request

going to first create an empty data frame, then create a for loop so that the API request iterates through each of the school districts data frame. Why do we wrap in a tryCatch statement?
```{r}
# create an empty data frame to populate with percentiles
districts_percentile <- data.frame()

# create a progress bar for our for loop
pb <- progress_bar$new(
  format = "  [:bar] :current/:total (:percent) elapsed: :elapsed full",
  total = nrow(districts), clear = FALSE, width = 60
)

# create a for loop for school districts
for (code in districts$CDSCode) {
   
  # iterate through one row at a time
  df <- districts %>% 
    filter(CDSCode == code)
  
  # API request
  tryCatch({ # wrap in tryCatch for what reason?
    # create the request, where "df" contains the simple features for our locations, and we use "CDSCode" as the unique identifier
    request <-  ca_loc_sf(loc = df, idfld = "CDSCode") %>% 
      # select our variable of interest, where "tasmax" is maximum temperature
      ca_cvar(cvar = "tasmax") %>% 
      # select the dataset we retrieve from, where Livneh is the historical climate observations
      ca_livneh(TRUE) %>% 
      # select daily values
      ca_period("day") %>% 
      # select period of interest
      ca_years(start = 1961, end = 1990)
    
    # calculate the 98th percentile for each school district based on retrieved data
    districts_temp <- request %>% 
      # extract values from request as a table, converting values to be numeric
      ca_getvals_tbl(quiet = TRUE) %>%
      mutate(val = as.numeric(val)) %>% 
      # calculate 98th percentile for each district
      summarize(pct_98 = quantile(val, probs = 0.98))
    
    # repopulate the district name field
    districts_temp$CDSCode <- code
    
    districts_percentile <- rbind(districts_percentile, districts_temp)
    },
    error = function(e) {
      # Print school districts API has difficulty with
      cat("Error occurred for district:", code, "\n")
      cat("Skipping this district.\n")
    })
  
  # update progress bar
  pb$tick()
  
} # end for loop
```

# trying for loop with centroids

```{r}
# create an empty data frame to populate with percentiles
pct_98_temp <- data.frame()

# create an empty vector to store the codes of districts that encounter an error
temp_errors <- c()

# create a progress bar for our for loop
pb <- progress_bar$new(
  format = "  [:bar] :current/:total (:percent) elapsed: :elapsed full",
  total = nrow(districts_points), clear = FALSE, width = 60
)

# create a for loop for school districts
for (code in districts_points$CDSCode) {
   
  # iterate through one row at a time
  df <- districts_points %>% 
    filter(CDSCode == code)
  
  # API request
  tryCatch({ # wrap in tryCatch for what reason?
    # create the request, where "df" contains the simple features for our locations, and we use "CDSCode" as the unique identifier
    request <-  ca_loc_sf(loc = df, idfld = "CDSCode") %>% 
      # select our variable of interest, where "tasmax" is maximum temperature
      ca_cvar(cvar = "tasmax") %>% 
      # select the dataset we retrieve from, where Livneh is the historical climate observations
      ca_livneh(TRUE) %>% 
      # select daily values
      ca_period("day") %>% 
      # select period of interest
      ca_years(start = 1961, end = 1990)
    
    # calculate the 98th percentile for each school district based on retrieved data
    districts_temp <- request %>% 
      # extract values from request as a table, converting values to be numeric
      ca_getvals_tbl(quiet = TRUE) %>%
      mutate(val = as.numeric(val)) %>% 
      # calculate 98th percentile for each district
      summarize(pct_98 = quantile(val, probs = 0.98))
    
    # repopulate the district name field
    districts_temp$CDSCode <- code
    
    pct_98_temp <- rbind(pct_98_temp, districts_temp)
    },
    error = function(e) {
      # store the district code in error_districts if there's an error
      temp_errors <<- c(temp_errors, code)
    })
  
  # update progress bar
  pb$tick()
  
} # end for loop
```

# working with errors

We need data for all school districts to make a proper estimate of a threshold for extreme heat. So, we are going to filter for the district that is causing the error (not the centroid point), generate 25 random points across its area, and feed those as locations into the API request.

```{r}
# filter for the district that is encountering an error
error_districts <- districts %>% 
  filter(CDSCode %in% temp_errors)

# generate 25 random points for school district
errors_points <- st_sample(error_districts, 25)
  
errors_points <- st_transform(errors_points, crs = "EPSG:4326" ) %>% 
  st_coordinates()

# feed into API request as coordinates
request <- ca_loc_pt(coords = errors_points) %>% 
  # select our variable of interest, where "tasmax" is maximum temperature
  ca_cvar(cvar = "tasmax") %>% 
  # select the dataset we retrieve from, where Livneh is the historical climate observations
  ca_livneh(TRUE) %>% 
  # select daily values
  ca_period("day") %>% 
  # select period of interest
  ca_years(start = 1961, end = 1990)

# get values
# calculate the 98th percentile for each school district based on retrieved data
errors_temp <- request %>% 
  # extract values from request as a table, converting values to be numeric
  ca_getvals_tbl(quiet = TRUE) %>%
  mutate(val = as.numeric(val)) %>% 
  # calculate 98th percentile for each district
  summarize(pct_98 = quantile(val, probs = 0.98))

# bind the error value back together with the 98th percentile values
errors_temp$CDSCode <- temp_errors

pct_98_temp <- rbind(pct_98_temp, errors_temp)
```

# finding the threshold

find the mean of all, and convert from celsius to fahrenheit

```{r}
## calculate threshold
threshold <- pct_98_temp %>% 
  summarise(mean = mean(pct_98) * 9 / 5 + 32)
```


So, we calculate our threshold to be 96 F. 35.72 C



